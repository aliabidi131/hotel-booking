import{c as u}from"./chunk-A7BXMC5C.js";import{ia as h}from"./chunk-JJWXYU2O.js";import{g as a,ga as n,ma as o,ob as i}from"./chunk-GQVS24Z7.js";var g=(()=>{class r{constructor(){this.supabase=o(h).supabase,this.router=o(u),this.currentUser=i(null),this.isLoading=i(!0),this.errorMessage=i(null),this.initAuth()}initAuth(){return a(this,null,function*(){try{let{data:{session:s}}=yield this.supabase.auth.getSession();s?.user&&this.setUserFromSession(s.user)}catch(s){console.error("Auth init error:",s)}finally{this.isLoading.set(!1)}this.supabase.auth.onAuthStateChange((s,e)=>a(this,null,function*(){console.log("Auth state changed:",s),s==="SIGNED_IN"&&e?.user?this.setUserFromSession(e.user):s==="SIGNED_OUT"&&this.currentUser.set(null),this.isLoading.set(!1)}))})}setUserFromSession(s){let e={uid:s.id,email:s.email||"",displayName:s.user_metadata?.display_name||s.user_metadata?.displayName||s.email?.split("@")[0]||"",role:s.user_metadata?.role||"user",createdAt:new Date(s.created_at)};this.currentUser.set(e)}signup(s){return a(this,null,function*(){this.errorMessage.set(null),this.isLoading.set(!0);try{let{data:e,error:t}=yield this.supabase.auth.signUp({email:s.email,password:s.password,options:{data:{display_name:s.displayName,displayName:s.displayName,role:"user"}}});if(t)throw this.errorMessage.set(t.message),t;e.user&&(this.setUserFromSession(e.user),this.router.navigate(["/"]))}finally{this.isLoading.set(!1)}})}login(s){return a(this,null,function*(){this.errorMessage.set(null),this.isLoading.set(!0);try{let{data:e,error:t}=yield this.supabase.auth.signInWithPassword({email:s.email,password:s.password});if(t)throw this.errorMessage.set(t.message),t;e.user&&(this.setUserFromSession(e.user),this.router.navigate(["/"]))}finally{this.isLoading.set(!1)}})}logout(){return a(this,null,function*(){yield this.supabase.auth.signOut(),this.currentUser.set(null),this.router.navigate(["/login"])})}setAdmin(s){return a(this,null,function*(){let{data:e,error:t}=yield this.supabase.auth.admin.updateUserById(this.currentUser()?.uid||"",{user_metadata:{role:"admin"}});t&&console.error("Error setting admin:",t)})}isAdmin(){return this.currentUser()?.role==="admin"}isAuthenticated(){return!!this.currentUser()}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=n({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{g as a};
