import{a as h}from"./chunk-ZTJU2KEZ.js";import{ia as p}from"./chunk-JJWXYU2O.js";import{a as k,g as o,ga as m,ma as l,u as c,z as u}from"./chunk-GQVS24Z7.js";var v=(()=>{class i{constructor(){this.supabase=l(p).supabase,this.authService=l(h)}getAllBookings(){return c(this.supabase.from("bookings").select("*").order("createdAt",{ascending:!1})).pipe(u(({data:t,error:s})=>{if(s)throw s;return t||[]}))}getUserBookings(t){return c(this.supabase.from("bookings").select("*").eq("userId",t).order("createdAt",{ascending:!1})).pipe(u(({data:s,error:e})=>{if(e)throw e;return s||[]}))}getHotelBookings(t){return c(this.supabase.from("bookings").select("*").eq("hotelId",t)).pipe(u(({data:s,error:e})=>{if(e)throw e;return s||[]}))}createBooking(t,s,e,n){return o(this,null,function*(){let r=this.authService.currentUser();if(!r)return{success:!1,message:"User must be logged in to create a booking"};try{let a={userId:r.uid,hotelId:t,hotelName:s,checkIn:e.checkIn,checkOut:e.checkOut,guests:e.guests,roomType:e.roomType,totalPrice:n,status:"pending",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()},{data:b,error:g}=yield this.supabase.from("bookings").insert(a).select().single();if(g)return console.error("Error creating booking:",g),{success:!1,message:"Failed to create booking: "+g.message};let d=b.id,f=yield this.sendBookingNotification({bookingId:d,userEmail:r.email,userName:r.displayName||r.email.split("@")[0],hotelName:s,checkIn:e.checkIn.toString(),checkOut:e.checkOut.toString(),guests:e.guests,roomType:e.roomType,totalPrice:n});return f.success||console.warn("Email notification failed, but booking was created:",f.error),{success:!0,bookingId:d,message:"Booking created successfully! Check your email for confirmation."}}catch(a){return console.error("Booking error:",a),{success:!1,message:"Error: "+a.message}}})}sendBookingNotification(t){return o(this,null,function*(){try{let{data:s,error:e}=yield this.supabase.functions.invoke("send-email",{body:k({type:"booking"},t)});return e?(console.error("Booking email error:",e),{success:!1,error:e.message}):(console.log("Booking notification sent:",s),{success:!0})}catch(s){return console.error("Email send error:",s),{success:!1,error:s.message}}})}updateBookingStatus(t,s){return o(this,null,function*(){let{error:e}=yield this.supabase.from("bookings").update({status:s,updatedAt:new Date().toISOString()}).eq("id",t);if(e)throw e})}cancelBooking(t){return o(this,null,function*(){yield this.updateBookingStatus(t,"cancelled")})}confirmBooking(t){return o(this,null,function*(){yield this.updateBookingStatus(t,"confirmed")})}deleteBooking(t){return o(this,null,function*(){let{error:s}=yield this.supabase.from("bookings").delete().eq("id",t);if(s)throw s})}calculateTotalPrice(t,s,e){let n=Math.abs(e.getTime()-s.getTime()),r=Math.ceil(n/(1e3*60*60*24));return t*Math.max(r,1)}getBookingById(t){return o(this,null,function*(){let{data:s,error:e}=yield this.supabase.from("bookings").select("*").eq("id",t).single();return e?(console.error("Error fetching booking:",e),null):s})}static{this.\u0275fac=function(s){return new(s||i)}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{v as a};
